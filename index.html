<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, viewport-fit=cover"
        />
        <meta name="theme-color" content="#f7f8fc" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <title>防音窓実験室 Noise Lab</title>
        <style>
            :root {
                --bg: #f7f8fc;
                --bg-alt: #ffffff;
                --text: #2d3142;
                --text-muted: #6b7280;
                --text-subtle: #9ca3af;
                --border: #e5e7eb;
                --shadow-dark: #d1d5db80;
                --shadow-light: #ffffff;
                --accent: #4f46e5;
                --accent-soft: #e0e7ff;
                --ok: #10b981;
                --ng: #ef4444;
                --surface: #ffffff;
                --surface-elevated: #ffffff;
                --card-radius: 16px;
                --btn-radius: 12px;
                --shadow-subtle: 4px;
                --shadow-soft: 8px;
                --shadow-elevated: 12px;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                margin: 0;
                padding: 0;
                background: var(--bg);
                color: var(--text);
                font-family:
                    "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", 
                    "Hiragino Sans", "Noto Sans JP", Roboto, "Helvetica Neue", 
                    Arial, sans-serif;
                font-feature-settings: "cv01", "cv02", "cv03", "cv04", "cv06", "cv11";
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                text-rendering: optimizeLegibility;
                font-size: 14px;
                line-height: 1.5;
            }

            /* Clean elevated surfaces */
            .nm-raised {
                background: var(--surface-elevated);
                border-radius: var(--card-radius);
                border: 1px solid var(--border);
                box-shadow:
                    0 1px 3px rgba(0, 0, 0, 0.06),
                    0 4px 16px rgba(0, 0, 0, 0.04);
                backdrop-filter: blur(8px);
            }
            .nm-inset {
                background: var(--bg);
                border-radius: var(--card-radius);
                border: 1px solid var(--border);
                box-shadow:
                    inset 0 2px 4px rgba(0, 0, 0, 0.04),
                    inset 0 -1px 0 rgba(255, 255, 255, 0.8);
            }
            .chip {
                font-size: 12px;
                color: var(--text-muted);
                padding: 8px 12px;
                border-radius: 999px;
                background: var(--accent-soft);
                border: 1px solid var(--border);
                line-height: 1;
                font-weight: 500;
            }

            /* App frame */
            .app {
                min-height: 100svh;
                max-width: 1000px;
                margin: 0 auto;
                display: grid;
                grid-template-rows: auto auto 1fr auto;
                gap: 32px;
                padding: 32px 24px 24px;
            }
            @media (max-width: 640px) {
                .app {
                    padding: 24px 16px 16px;
                    gap: 24px;
                }
            }

            /* Header: title + compact BT */
            .topbar {
                display: flex;
                align-items: center;
                gap: 16px;
                flex-wrap: wrap;
                margin-bottom: 8px;
            }
            .topbar h1 {
                margin: 0;
                font-size: 24px;
                font-weight: 600;
                letter-spacing: -0.5px;
                color: var(--text);
            }
            .topbar .spacer {
                flex: 1 1 auto;
            }
            .bt-chip {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                border-radius: 999px;
                background: var(--surface);
                border: 1px solid var(--border);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
                color: var(--text-muted);
                white-space: nowrap;
                line-height: 1;
            }
            .bt-chip .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                border: 1px solid var(--border);
            }
            .bt-chip .dot.ok {
                background: var(--ok);
                box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            }
            .bt-chip .dot.ng {
                background: var(--ng);
                box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
            }
            .bt-chip .lbl {
                font-size: 13px;
                font-weight: 500;
                color: var(--text);
            }
            .bt-chip .btn {
                appearance: none;
                border: 1px solid var(--border);
                background: var(--surface);
                border-radius: 8px;
                padding: 6px 10px;
                font-size: 12px;
                font-weight: 500;
                color: var(--text);
                cursor: pointer;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
                transition: all 0.15s ease;
            }
            .bt-chip .btn:hover {
                background: var(--bg);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            }
            .bt-chip .btn:active {
                transform: translateY(1px);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            }
            .bt-chip .btn:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            /* Metrics: single row (dB chip + subtle sparkline) */
            .metrics {
                display: grid;
                grid-template-columns: auto 1fr;
                gap: 24px;
                align-items: center;
                padding: 24px 32px;
            }
            .db-chip {
                display: grid;
                gap: 8px;
                padding: 0;
                min-width: 200px;
                justify-items: center;
            }
            .db-chip .label {
                font-size: 12px;
                font-weight: 500;
                color: var(--text-muted);
                letter-spacing: 0.5px;
                text-transform: uppercase;
            }
            .db-chip .value {
                font-variant-numeric: tabular-nums;
                font-weight: 700;
                font-size: 32px;
                line-height: 1;
                color: var(--text);
            }
            .spark {
                padding: 0;
                display: grid;
                align-items: center;
            }
            canvas#spectrum {
                width: 100%;
                height: 64px;
                display: block;
                border-radius: 12px;
                opacity: 0.8;
            }
            @media (max-width: 640px) {
                .metrics {
                    grid-template-columns: 1fr;
                    padding: 20px 24px;
                    gap: 20px;
                }
                .db-chip {
                    min-width: 0;
                }
                canvas#spectrum {
                    height: 48px;
                }
            }
            @media (min-width: 900px) and (orientation: landscape) {
                canvas#spectrum {
                    height: 72px;
                }
            }

            /* Sound panel */
            .sound-panel {
                padding: 32px;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }
            .sound-scroll {
                overflow: auto;
                padding: 0;
            }
            .grid {
                display: grid;
                gap: 20px;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                align-items: start;
            }
            @media (max-width: 640px) {
                .sound-panel {
                    padding: 24px 20px;
                }
                .grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }
            }

            /* Clean sound buttons */
            .nm-btn {
                appearance: none;
                border: 1px solid var(--border);
                width: 100%;
                background: var(--surface);
                border-radius: var(--btn-radius);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
                padding: 20px;
                cursor: pointer;
                color: var(--text);
                text-align: left;
                transition: all 0.2s ease;
                min-height: 80px;
                position: relative;
                overflow: hidden;
            }
            .nm-btn:hover {
                border-color: var(--accent);
                box-shadow: 
                    0 4px 12px rgba(0, 0, 0, 0.08),
                    0 0 0 1px var(--accent);
                transform: translateY(-1px);
            }
            .nm-btn.is-active {
                background: var(--accent-soft);
                border-color: var(--accent);
                box-shadow: 
                    0 2px 8px rgba(79, 70, 229, 0.12),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
            }
            .nm-btn:active {
                transform: translateY(0);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            }
            .nm-btn:focus-visible {
                outline: 2px solid var(--accent);
                outline-offset: 2px;
            }

            .sound-btn {
                display: grid;
                grid-template-columns: 40px 1fr;
                gap: 16px;
                align-items: center;
                height: 100%;
            }
            .sound-btn .icon {
                width: 40px;
                height: 40px;
                display: grid;
                place-items: center;
                font-size: 20px;
                line-height: 1;
                background: var(--bg);
                border-radius: 8px;
                border: 1px solid var(--border);
            }
            .sound-btn .text {
                display: flex;
                flex-direction: column;
                gap: 6px;
                min-width: 0;
            }
            .sound-btn .title {
                font-weight: 600;
                font-size: 16px;
                line-height: 1.3;
                color: var(--text);
            }
            .sound-btn .desc {
                font-size: 13px;
                color: var(--text-muted);
                line-height: 1.4;
            }

            footer.note {
                font-size: 12px;
                color: var(--text-subtle);
                text-align: center;
                padding-bottom: 8px;
                line-height: 1.5;
            }
            @media (prefers-reduced-motion: reduce) {
                .nm-btn,
                .bt-chip .btn {
                    transition: none;
                    transform: none !important;
                }
            }
        </style>
    </head>
    <body>
        <div class="app">
            <header class="topbar">
                <span class="chip" aria-hidden="true">PWA</span>
                <h1>防音窓実験室 Noise Lab</h1>
                <div class="spacer"></div>
                <div class="bt-chip" aria-label="Bluetoothスピーカー接続状態">
                    <span id="btDot" class="dot ng" aria-hidden="true"></span>
                    <span id="btLabel" class="lbl">未接続</span>
                    <button
                        id="connectBtn"
                        class="btn"
                        type="button"
                        aria-label="スピーカーに接続"
                    >
                        接続
                    </button>
                </div>
            </header>

            <!-- dB + スパークライン（横並び、控えめ） -->
            <section class="nm-raised metrics" aria-label="音量とスペクトラム">
                <div class="nm-inset db-chip">
                    <div class="label">相対音量 [dBFS]</div>
                    <div id="dbValue" class="value">--.- dB</div>
                </div>
                <div class="nm-inset spark">
                    <canvas
                        id="spectrum"
                        aria-label="スペクトラム（参考表示）"
                        role="img"
                    ></canvas>
                </div>
            </section>

            <!-- メイン：再生ボタン（約7割） -->
            <section
                class="nm-raised sound-panel"
                aria-label="生活音の再生ボタン"
            >
                <div class="sound-scroll">
                    <div class="grid">
                        <button
                            class="nm-btn sound-btn"
                            data-sound="voice"
                            aria-pressed="false"
                        >
                            <div class="icon" aria-hidden="true">💬</div>
                            <div class="text">
                                <div class="title">話し声</div>
                                <div class="desc">
                                    中域中心の断続的な声の感じ
                                </div>
                            </div>
                        </button>
                        <button
                            class="nm-btn sound-btn"
                            data-sound="tv"
                            aria-pressed="false"
                        >
                            <div class="icon" aria-hidden="true">📺</div>
                            <div class="text">
                                <div class="title">テレビ音</div>
                                <div class="desc">広帯域のにぎやかな音</div>
                            </div>
                        </button>
                        <button
                            class="nm-btn sound-btn"
                            data-sound="construction"
                            aria-pressed="false"
                        >
                            <div class="icon" aria-hidden="true">🚧</div>
                            <div class="text">
                                <div class="title">工事音</div>
                                <div class="desc">低音の打撃＋騒音バースト</div>
                            </div>
                        </button>
                        <button
                            class="nm-btn sound-btn"
                            data-sound="laundry"
                            aria-pressed="false"
                        >
                            <div class="icon" aria-hidden="true">🧺</div>
                            <div class="text">
                                <div class="title">洗濯機</div>
                                <div class="desc">低周波モーター＋揺れ</div>
                            </div>
                        </button>
                        <button
                            class="nm-btn sound-btn"
                            data-sound="rain"
                            aria-pressed="false"
                        >
                            <div class="icon" aria-hidden="true">🌧️</div>
                            <div class="text">
                                <div class="title">雨音</div>
                                <div class="desc">高域成分のパラパラ音</div>
                            </div>
                        </button>
                        <button
                            class="nm-btn sound-btn"
                            data-sound="traffic"
                            aria-pressed="false"
                        >
                            <div class="icon" aria-hidden="true">🚗</div>
                            <div class="text">
                                <div class="title">交通騒音</div>
                                <div class="desc">低〜中域の連続的なノイズ</div>
                            </div>
                        </button>
                    </div>
                </div>
            </section>

            <footer class="note">
                表示dBは相対値（dBFS）。実際の騒音計ではありません。OSのBluetooth設定はブラウザから直接開けません。
            </footer>
        </div>

        <script>
            // Audio + Analyzer
            let audioCtx;
            let masterGain, analyser, dest, mediaOutEl;
            let currentSoundStop = null;

            function ensureAudio() {
                if (audioCtx) return;
                audioCtx = new (window.AudioContext ||
                    window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.9;

                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.85;

                masterGain.connect(analyser);

                dest = audioCtx.createMediaStreamDestination();
                analyser.connect(dest);
                mediaOutEl = new Audio();
                mediaOutEl.autoplay = true;
                mediaOutEl.srcObject = dest.stream;
                mediaOutEl.play().catch(() => {});
            }

            function createNoiseBuffer(lenSec = 2) {
                const sr = audioCtx.sampleRate;
                const length = Math.max(1, Math.floor(sr * lenSec));
                const buffer = audioCtx.createBuffer(1, length, sr);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < length; i++)
                    data[i] = Math.random() * 2 - 1;
                return buffer;
            }
            function makeBufferSource(buffer, loop = true) {
                const src = audioCtx.createBufferSource();
                src.buffer = buffer;
                src.loop = loop;
                return src;
            }

            // --- Sound file playback ---
            const SOUND_FILES = {
                voice: "sounds/voice.mp3",
                tv: "sounds/tv.mp3",
                construction: "sounds/construction.mp3",
                laundry: "sounds/laundry.mp3",
                rain: "sounds/rain.mp3",
                traffic: "sounds/traffic.mp3",
            };
            const audioBuffers = {}; // Cache for decoded audio data

            // Function to load and decode a sound file
            async function loadSound(kind) {
                if (audioBuffers[kind]) {
                    return audioBuffers[kind]; // Return from cache
                }
                const filePath = SOUND_FILES[kind];
                if (!filePath) {
                    console.error(`Sound kind "${kind}" not found in SOUND_FILES.`);
                    return null;
                }
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                    audioBuffers[kind] = audioBuffer; // Store in cache
                    return audioBuffer;
                } catch (e) {
                    console.error(`Error loading sound "${kind}" from ${filePath}:`, e);
                    alert(`音声ファイル「${filePath}」の読み込みに失敗しました。`);
                    return null;
                }
            }

            // In this new implementation, currentSoundStop will hold the active AudioBufferSourceNode
            async function startSound(kind) {
                ensureAudio();
                await audioCtx.resume();
                stopSound(); // Stop any currently playing sound

                const audioBuffer = await loadSound(kind);
                if (!audioBuffer) {
                    // Deselect the button if loading fails
                    const activeBtn = document.querySelector(`.sound-btn[data-sound="${kind}"]`);
                    if (activeBtn) {
                        activeBtn.classList.remove("is-active");
                        activeBtn.setAttribute("aria-pressed", "false");
                    }
                    return;
                }

                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;
                source.connect(masterGain);
                source.start(0);

                currentSoundStop = source; // Store the source node to stop it later
            }

            function stopSound() {
                if (currentSoundStop) {
                    try {
                        // stop() can be called only once
                        currentSoundStop.stop(0);
                        currentSoundStop.disconnect();
                    } catch (e) {
                        // Ignore errors, e.g., if the node was already stopped
                    }
                    currentSoundStop = null;
                }
            }

            // UI wiring
            const btns = Array.from(document.querySelectorAll(".sound-btn"));
            btns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const kind = btn.dataset.sound;
                    const isActive = btn.classList.contains("is-active");
                    btns.forEach((b) => {
                        b.classList.remove("is-active");
                        b.setAttribute("aria-pressed", "false");
                    });
                    if (isActive) stopSound();
                    else {
                        btn.classList.add("is-active");
                        btn.setAttribute("aria-pressed", "true");
                        startSound(kind);
                    }
                });
            });

            // dB + subtle sparkline
            const dbEl = document.getElementById("dbValue");
            const canvas = document.getElementById("spectrum");
            const ctx2d = canvas.getContext("2d");

            function resizeCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = Math.floor(rect.width * dpr);
                canvas.height = Math.floor(rect.height * dpr);
                ctx2d.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
            new ResizeObserver(resizeCanvas).observe(canvas);
            resizeCanvas();

            function draw() {
                requestAnimationFrame(draw);
                const rect = canvas.getBoundingClientRect();
                ctx2d.clearRect(0, 0, rect.width, rect.height);
                if (!analyser) return;

                // dBFS
                const timeArr = new Float32Array(analyser.fftSize);
                analyser.getFloatTimeDomainData(timeArr);
                let sum = 0;
                for (let i = 0; i < timeArr.length; i++)
                    sum += timeArr[i] * timeArr[i];
                const rms = Math.sqrt(sum / timeArr.length) || 1e-9;
                const dbfs = 20 * Math.log10(rms);
                dbEl.textContent = `${dbfs.toFixed(1)} dB`;

                // Sparkline（控えめ）
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                const w = rect.width,
                    h = rect.height;
                const points = 60;
                const step = Math.max(1, Math.floor(bufferLength / points));

                const vals = [];
                let prev = 0;
                for (let i = 0; i < points; i++) {
                    let acc = 0;
                    for (let j = 0; j < step; j++)
                        acc += dataArray[i * step + j] || 0;
                    let v = acc / step / 255;
                    v = prev * 0.65 + v * 0.35;
                    prev = v; // smooth
                    vals.push(v);
                }

                const padX = 6,
                    padY = 6;
                const innerW = w - padX * 2,
                    innerH = h - padY * 2;
                const toX = (i) => padX + (i / (points - 1)) * innerW;
                const toY = (v) => padY + (1 - v) * innerH * 0.85;

                // area
                ctx2d.beginPath();
                ctx2d.moveTo(toX(0), toY(vals[0]));
                for (let i = 1; i < points; i++)
                    ctx2d.lineTo(toX(i), toY(vals[i]));
                ctx2d.lineTo(toX(points - 1), h - padY);
                ctx2d.lineTo(toX(0), h - padY);
                ctx2d.closePath();
                ctx2d.fillStyle = "rgba(79, 70, 229, 0.08)";
                ctx2d.fill();

                // line
                ctx2d.beginPath();
                ctx2d.moveTo(toX(0), toY(vals[0]));
                for (let i = 1; i < points; i++)
                    ctx2d.lineTo(toX(i), toY(vals[i]));
                ctx2d.strokeStyle = "rgba(79, 70, 229, 0.4)";
                ctx2d.lineWidth = 2;
                ctx2d.stroke();
            }
            draw();

            // Output device selection
            const connectBtn = document.getElementById("connectBtn");
            const btDot = document.getElementById("btDot");
            const btLabel = document.getElementById("btLabel");

            async function connectSpeaker() {
                ensureAudio();
                try {
                    if (
                        navigator.mediaDevices &&
                        "selectAudioOutput" in navigator.mediaDevices
                    ) {
                        const device =
                            await navigator.mediaDevices.selectAudioOutput();
                        if (device && device.deviceId && mediaOutEl.setSinkId) {
                            await mediaOutEl.setSinkId(device.deviceId);
                            setBtStatus(
                                true,
                                device.label || "出力デバイス選択済み",
                            );
                            return;
                        }
                    }
                    if (mediaOutEl.setSinkId) {
                        await mediaOutEl.setSinkId("default");
                        setBtStatus(true, "既定の出力に設定しました");
                    } else {
                        setBtStatus(false, "出力先選択は非対応");
                        alert(
                            "このブラウザでは出力デバイスの直接選択に未対応です。OSのBluetooth設定またはブラウザの音声出力設定からスピーカーを選択してください。",
                        );
                    }
                } catch (e) {
                    console.error(e);
                    setBtStatus(false, "接続に失敗");
                    alert(
                        "出力デバイスの選択に失敗しました。権限や接続状態をご確認ください。",
                    );
                }
            }
            function setBtStatus(connected, tip) {
                btDot.classList.toggle("ok", connected);
                btDot.classList.toggle("ng", !connected);
                btLabel.textContent = connected ? "接続済み" : "未接続";
                const chip = btLabel.closest(".bt-chip");
                if (chip)
                    chip.title =
                        tip ||
                        (connected
                            ? "音声出力がスピーカーに設定されました"
                            : "対応ブラウザで出力デバイスを選択できます");
            }
            connectBtn.addEventListener("click", connectSpeaker);

            window.addEventListener("pagehide", () => {
                stopSound();
            });
        </script>
    </body>
</html>
